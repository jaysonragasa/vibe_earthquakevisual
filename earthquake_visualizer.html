<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recent Earthquakes Visualizer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Basic Styles */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column; /* Default to column for mobile */
            height: 100vh;
            margin: 0;
            transition: background-color 0.3s;
            overflow: hidden; /* Prevent body scroll */
        }
        #map {
            height: 100%;
            flex-grow: 1;
            z-index: 1;
        }
        #controls-container {
            /* Mobile Bottom Sheet Styles */
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1001;
            transform: translateY(calc(100% - 4rem)); /* Start collapsed, showing handle area */
            transition: transform 0.3s ease-in-out;
        }
        #controls-container.is-open {
            transform: translateY(0); /* Fully visible */
        }
        #controls {
            height: 75vh;
            overflow-y: auto;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            position: relative;
            /* Hide scrollbar */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        #controls::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        #sheet-toggle {
            padding-top: 6px;
            padding-bottom: 23px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        #sheet-handle-bar {
            width: 50px;
            height: 5px;
            border-radius: 2.5px;
        }
        
        .control-group {
            padding-bottom: 15px;
        }

        /* Desktop Sidebar Styles */
        @media (min-width: 768px) {
            body {
                flex-direction: row;
            }
            #controls-container {
                position: static;
                transform: none;
                width: 380px;
                height: 100vh;
            }
            #controls {
                height: 100%;
                border-radius: 0;
                padding: 0rem;
                box-shadow: none;
            }
            #sheet-toggle {
                display: none;
            }
        }

        /* Light Mode */
        body { background-color: #f0f2f5; }
        #controls { background-color: white; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        #sheet-handle-bar { background-color: #d1d5db; }
        label { color: #374151; }
        input, select, textarea { background-color: white; border: 1px solid #d1d5db; color: #111827; }
        input:focus, select:focus, textarea:focus { border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        .leaflet-tile { filter: none; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }


        /* Dark Mode */
        .dark body { background-color: #111827; }
        .dark #controls { background-color: #1f2937; box-shadow: 0 -5px 15px rgba(0,0,0,0.5); }
        .dark #sheet-handle-bar { background-color: #4b5563; }
        .dark label { color: #d1d5db; }
        .dark h1, .dark h2 { color: #f9fafb; }
        .dark input, .dark select, .dark textarea { background-color: #374151; border-color: #4b5563; color: #f9fafb; }
        .dark input:focus, .dark select:focus, .dark textarea:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3); }
        .dark .map-is-terrain .leaflet-tile { filter: invert(1) hue-rotate(180deg) brightness(95%) contrast(90%); }
        .dark .map-is-satellite .leaflet-tile { filter: brightness(0.9) contrast(1.1); }
        .dark .leaflet-popup-content-wrapper, .dark .leaflet-popup-tip { background: #2d3748; color: #e2e8f0; }
        .dark button:disabled { background-color: #4b5563; }


        /* Loading Indicator */
        #loading {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 8px 12px;
            border-radius: 5px;
            z-index: 4000;
            font-weight: 600;
            display: none;
            flex-direction: row;
            align-items: center;
            gap: 8px;
        }
        .spinner {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        body:not(.dark) #loading { background: white; color: #333; box-shadow: 0 1px 5px rgba(0,0,0,0.65); }
        body:not(.dark) .spinner { border-color: #e5e7eb; border-top-color: #4f46e5; }
        .dark #loading { background: #1f2937; color: #f9fafb; box-shadow: 0 1px 5px rgba(0,0,0,0.65); }
        .dark .spinner { border-color: #4b5563; border-top-color: #6366f1; }
        
        /* Theme Toggle Switch */
        .theme-switch-wrapper { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; }
        input:checked + .slider { background-color: #4f46e5; }
        input:checked + .slider:before { transform: translateX(24px); }
        .slider.round { border-radius: 24px; }
        .slider.round:before { border-radius: 50%; }

        /* Legend Styles */
        .legend-container { transition: all 0.3s ease-in-out; }
        .legend-content { padding: 10px; font-size: 14px; line-height: 23px; border-radius: 5px; }
        .legend-content h4 { margin-top: 0; margin-bottom: 5px; font-weight: bold; }
        .legend-content i { width: 20px; height: 20px; float: left; margin-right: 8px; opacity: 0.9; border-radius: 50%; }
        #legend-toggle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; float: right; margin: 5px; }
        #legend-toggle svg { width: 24px; height: 24px; }
        body:not(.dark) .legend-content { background: white; box-shadow: 0 0 15px rgba(0,0,0,0.2); color: #333; }
        body:not(.dark) #legend-toggle { background: white; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        body:not(.dark) #legend-toggle svg { fill: #333; }
        .dark .legend-content { background: #1f2937; color: #f9fafb; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        .dark #legend-toggle { background: #1f2937; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        .dark #legend-toggle svg { fill: #f9fafb; }
        
        @media (max-width: 767px) {
            .leaflet-bottom.leaflet-right { bottom: 4.5rem; }
            .legend-content { max-height: 0; overflow: hidden; padding: 0 10px; transition: max-height 0.3s ease-out, padding 0.3s ease-out; float: right; clear: both; }
            .legend-container.expanded .legend-content { max-height: 300px; padding: 10px; }
        }
        @media (min-width: 768px) { #legend-toggle { display: none; } }

        /* Locate Button Styles */
        .leaflet-bar a.leaflet-control-locate { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23333"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>'); background-size: 20px 20px; background-repeat: no-repeat; background-position: center; }
        .dark .leaflet-bar a.leaflet-control-locate { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23fff"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>'); }

        /* Modal Styles */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; display: none; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.5); }
        .modal-content { max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 2rem; border-radius: 1rem; }
        #image-preview { width: 100%; height: 200px; object-fit: cover; border-radius: 0.5rem; margin-bottom: 1rem; }
        body:not(.dark) .modal-content { background-color: white; }
        .dark .modal-content { background-color: #1f2937; }

        /* Welcome Modal Override */
        #welcome-modal .modal-content, .dark #welcome-modal .modal-content {
            background-color: white;
        }
        #welcome-modal h2, .dark #welcome-modal h2 {
            color: black;
        }
        #welcome-modal p, #welcome-modal label, .dark #welcome-modal p, .dark #welcome-modal label {
            color: #1f2937;
        }

        /* Image Viewer Modal */
        #image-viewer-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: none; align-items: center; justify-content: center;
            z-index: 11000;
        }
        #viewer-image { max-width: 90%; max-height: 90%; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        #close-viewer-btn {
            position: absolute; top: 20px; right: 30px;
            font-size: 40px; color: white; cursor: pointer;
            line-height: 1;
        }
        #view-on-map-link {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            color: white; background-color: rgba(0,0,0,0.5);
            padding: 8px 16px; border-radius: 5px; text-decoration: none;
        }
        #view-on-map-link:hover { background-color: rgba(0,0,0,0.8); }

        /* Gallery Popup */
        .gallery-popup-container {
            max-height: 300px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 5px;
        }
        .gallery-popup-container img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            cursor: pointer;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="controls-container">
        <div id="controls" class="p-6 md:p-0">
            <div id="sheet-toggle">
                <div id="sheet-handle-bar"></div>
            </div>
            <div class="controls-content px-6 pb-6 md:p-6">
                <h1 class="text-2xl font-bold mb-1">Earthquake Visualizer</h1>
                <p class="text-sm text-gray-400 mb-4">earthquake.usgs.gov</p>
                <div class="theme-switch-wrapper">
                    <label for="theme-switch">Dark Mode</label>
                    <label class="theme-switch">
                        <input type="checkbox" id="theme-switch" checked>
                        <span class="slider round"></span>
                    </label>
                </div>
                <div class="theme-switch-wrapper">
                    <label for="map-style-switch">Street Map View</label>
                    <label class="theme-switch">
                        <input type="checkbox" id="map-style-switch">
                        <span class="slider round"></span>
                    </label>
                </div>
                <div class="control-group">
                    <label for="start-date">Start Date</label>
                    <input type="date" id="start-date" class="w-full p-2 border rounded-md">
                </div>
                <div class="control-group">
                    <label for="end-date">End Date</label>
                    <input type="date" id="end-date" class="w-full p-2 border rounded-md">
                </div>
                <div class="control-group">
                    <label for="min-magnitude">Min Magnitude</label>
                    <input type="number" id="min-magnitude" min="0" max="10" step="0.1" value="2.5" class="w-full p-2 border rounded-md">
                </div>
                <div class="control-group">
                    <label for="max-magnitude">Max Magnitude</label>
                    <input type="number" id="max-magnitude" min="0" max="10" step="0.1" value="10" class="w-full p-2 border rounded-md">
                </div>
                <div class="control-group">
                    <label for="country-filter">Country</label>
                    <select id="country-filter" class="w-full p-2 border rounded-md">
                        <option value="">All Countries</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="city-filter">City</label>
                    <select id="city-filter" class="w-full p-2 border rounded-md" disabled>
                        <option value="">All Cities</option>
                    </select>
                </div>
                <button id="refresh-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-md hover:bg-indigo-700 transition duration-300 mt-4">
                    Refresh Data
                </button>
            </div>
        </div>
    </div>

    <div id="submission-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-4">Submit a Report</h2>
            <img id="image-preview" src="https://placehold.co/600x400/374151/f9fafb?text=Select+an+Image" alt="Image preview">
            <div class="control-group">
                <label for="image-upload">Upload Image</label>
                <input type="file" id="image-upload" accept="image/*" class="w-full p-2 border rounded-md file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
            </div>
             <div class="control-group">
                <label for="date-taken">Date Taken</label>
                <input type="date" id="date-taken" class="w-full p-2 border rounded-md">
            </div>
            <div class="control-group">
                <label for="username">Your Name</label>
                <input type="text" id="username" placeholder="Anonymous" class="w-full p-2 border rounded-md">
            </div>
            <div class="control-group">
                <label for="description">Description</label>
                <textarea id="description" rows="3" class="w-full p-2 border rounded-md"></textarea>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-4">
                Note: We securely store your uploaded images and never share or sell them to third parties. A watermark with your provided name will be added to each image. Please ensure you have the right to upload the content, as you are responsible for it. We also do not collect or store any location data.
            </p>
            <div class="flex justify-end gap-4 mt-4">
                <button id="close-modal-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600 transition duration-300">Cancel</button>
                <button id="submit-report-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-300">Submit</button>
            </div>
        </div>
    </div>
    
    <div id="welcome-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Welcome to the Earthquake Visualizer!</h2>
            <p class="mb-4">This map shows recent earthquakes from around the world, based on data from the USGS.</p>
            <p class="mb-4"><strong>To add a photo report:</strong> Just zoom to your current location or tap any location where the event is related and upload a picture.</p>
            <div class="flex items-center mt-6 mb-4">
                <input type="checkbox" id="dont-show-again" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="dont-show-again" class="ml-2 block text-sm">Don't show this again</label>
            </div>
            <button id="close-welcome-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 transition">Got it!</button>
        </div>
    </div>

    <div id="loading">
        <div class="spinner"></div>
        <span id="loading-text"></span>
    </div>

    <div id="image-viewer-modal">
        <span id="close-viewer-btn">&times;</span>
        <img id="viewer-image" src="">
        <a href="#" id="view-on-map-link">View on Map</a>
    </div>

    <!-- Main Application Script -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- APPLICATION STATE ---
        const appState = {
            db: null,
            auth: null,
            map: null,
            heatLayer: null,
            earthquakeMarkers: null,
            locationReportMarkers: null,
            allEarthquakes: [],
            countriesData: [],
            citiesData: [],
            currentSubmissionContext: null
        };

        // --- DOM ELEMENT REFERENCES ---
        const dom = {
            loading: document.getElementById('loading'),
            loadingText: document.getElementById('loading-text'),
            loadingSpinner: document.querySelector('#loading .spinner'),
            submissionModal: document.getElementById('submission-modal'),
            modalTitle: document.getElementById('modal-title'),
            closeModalBtn: document.getElementById('close-modal-btn'),
            submitReportBtn: document.getElementById('submit-report-btn'),
            imageUpload: document.getElementById('image-upload'),
            imagePreview: document.getElementById('image-preview'),
            username: document.getElementById('username'),
            description: document.getElementById('description'),
            dateTaken: document.getElementById('date-taken'),
            map: document.getElementById('map'),
            startDate: document.getElementById('start-date'),
            endDate: document.getElementById('end-date'),
            minMagnitude: document.getElementById('min-magnitude'),
            maxMagnitude: document.getElementById('max-magnitude'),
            countryFilter: document.getElementById('country-filter'),
            cityFilter: document.getElementById('city-filter'),
            themeSwitch: document.getElementById('theme-switch'),
            mapStyleSwitch: document.getElementById('map-style-switch'),
            controlsContainer: document.getElementById('controls-container'),
            sheetToggle: document.getElementById('sheet-toggle'),
            refreshBtn: document.getElementById('refresh-btn'),
            imageViewerModal: document.getElementById('image-viewer-modal'),
            viewerImage: document.getElementById('viewer-image'),
            closeViewerBtn: document.getElementById('close-viewer-btn'),
            viewOnMapLink: document.getElementById('view-on-map-link'),
            welcomeModal: document.getElementById('welcome-modal'),
            closeWelcomeBtn: document.getElementById('close-welcome-btn'),
            dontShowAgainCheck: document.getElementById('dont-show-again')
        };

        // --- UI MODULE ---
        const uiModule = {
            showLoading(text, showSpinner = false) {
                dom.loadingText.textContent = text;
                dom.loadingSpinner.style.display = showSpinner ? 'block' : 'none';
                dom.loading.style.display = 'flex';
            },
            hideLoading(delay = 0) {
                if (delay > 0) {
                    setTimeout(() => { dom.loading.style.display = 'none'; }, delay);
                } else {
                    dom.loading.style.display = 'none';
                }
            },
            openImageViewer(src, lat, lng) {
                dom.viewerImage.src = src;
                dom.imageViewerModal.style.display = 'flex';
                dom.viewOnMapLink.onclick = (e) => {
                    e.preventDefault();
                    this.closeImageViewer();
                    appState.map.flyTo([lat, lng], 18);
                };
            },
            closeImageViewer() {
                dom.imageViewerModal.style.display = 'none';
                dom.viewerImage.src = '';
            },
            openSubmissionModal(context) {
                appState.currentSubmissionContext = context;
                dom.modalTitle.textContent = context.type === 'earthquake' ? 'Submit Earthquake Report' : 'Submit Location Report';
                dom.submissionModal.style.display = 'flex';
            },
            closeSubmissionModal() {
                dom.submissionModal.style.display = 'none';
                this.resetSubmissionForm();
            },
            openWelcomeModal() {
                dom.welcomeModal.style.display = 'flex';
            },
            closeWelcomeModal() {
                dom.welcomeModal.style.display = 'none';
            },
            resetSubmissionForm() {
                appState.currentSubmissionContext = null;
                dom.imageUpload.value = '';
                dom.username.value = '';
                dom.description.value = '';
                dom.dateTaken.value = '';
                dom.imagePreview.src = 'https://placehold.co/600x400/374151/f9fafb?text=Select+an+Image';
            },
            toggleModalForm(disabled) {
                const elements = [dom.submitReportBtn, dom.closeModalBtn, dom.imageUpload, dom.dateTaken, dom.username, dom.description];
                elements.forEach(el => el.disabled = disabled);
            },
            resizeAndWatermarkImage(file, maxWidth, maxHeight, quality, username) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                            } else {
                                if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                            }

                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // --- Watermark ---
                            const fontSize1 = Math.max(12, width / 40);
                            const fontSize2 = Math.max(14, width / 35);
                            const padding = 10;

                            // Background
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                            const text1 = 'Uploaded by:';
                            const text2 = username;
                            ctx.font = `bold ${fontSize2}px Inter, sans-serif`;
                            const textWidth = Math.max(ctx.measureText(text1).width, ctx.measureText(text2).width);
                            const textHeight = (fontSize1 + fontSize2) * 1.2;
                            ctx.fillRect( (width - textWidth) / 2 - padding, height - textHeight - (padding*2), textWidth + (padding*2), textHeight + padding);

                            // Text
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';
                            
                            // Line 1
                            ctx.font = `${fontSize1}px Inter, sans-serif`;
                            ctx.fillText(text1, width / 2, height - fontSize2 * 1.2 - padding);
                            
                            // Line 2
                            ctx.font = `bold ${fontSize2}px Inter, sans-serif`;
                            ctx.fillText(text2, width / 2, height - padding);

                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
        };

        // --- API MODULE ---
        const apiModule = {
            async fetchCountryCityData() {
                try {
                    const [countriesRes, citiesRes] = await Promise.all([
                        fetch('https://raw.githubusercontent.com/dr5hn/countries-states-cities-database/master/json/countries.json'),
                        fetch('https://raw.githubusercontent.com/dr5hn/countries-states-cities-database/master/json/cities.json')
                    ]);
                    appState.countriesData = await countriesRes.json();
                    appState.citiesData = await citiesRes.json();
                    mapModule.populateCountries();
                } catch (error) {
                    console.error("Error fetching country/city data:", error);
                }
            },
            async fetchEarthquakes() {
                uiModule.showLoading('Loading earthquake data...', true);
                const { value: startDate } = dom.startDate;
                const endDateValue = dom.endDate.value;
                const { value: minMag } = dom.minMagnitude;
                const { value: maxMag } = dom.maxMagnitude;
                
                const endDateObj = new Date(endDateValue);
                endDateObj.setDate(endDateObj.getDate() + 1);
                const correctedEndDate = endDateObj.toISOString().split('T')[0];

                const apiUrl = `https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&starttime=${startDate}&endtime=${correctedEndDate}&minmagnitude=${minMag}&maxmagnitude=${maxMag}`;

                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        const errorText = await response.text();
                        const userMessage = errorText.split('\n')[1] || "An error occurred. Please adjust your filters.";
                        uiModule.showLoading(userMessage);
                        uiModule.hideLoading(5000);
                        return;
                    }
                    const data = await response.json();
                    appState.allEarthquakes = data.features;
                    eventHandlers.applyFilters();
                    uiModule.hideLoading();
                } catch (error) {
                    console.error("Error fetching earthquake data:", error);
                    uiModule.showLoading("Could not fetch data due to a network error.");
                    uiModule.hideLoading(3000);
                }
            },
            async getAddressFromCoords(latitude, longitude) {
                try {
                    const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`);
                    const data = await response.json();
                    return {
                        countryName: (data.countryName || '').replace(/\s*\(.*\)/, '').trim(),
                        city: data.city || ''
                    };
                } catch (error) {
                    console.error("Geocoding failed:", error);
                    return { countryName: '', city: '' };
                }
            }
        };

        // --- FIREBASE MODULE ---
        const firebaseModule = {
            init() {
                const firebaseConfig = {
                    apiKey: "%VITE_FIREBASE_API_KEY%",
                    authDomain: "%VITE_FIREBASE_AUTH_DOMAIN%",
                    projectId: "%VITE_FIREBASE_PROJECT_ID%",
                    storageBucket: "%VITE_FIREBASE_STORAGE_BUCKET%",
                    messagingSenderId: "%VITE_FIREBASE_MESSAGING_SENDER_ID%",
                    appId: "%VITE_FIREBASE_APP_ID%",
                    measurementId: "%VITE_FIREBASE_MEASUREMENT_ID%"
                };
                
                const isConfigured = firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("%");
                if (isConfigured) {
                    try {
                        const app = initializeApp(firebaseConfig);
                        appState.auth = getAuth(app);
                        appState.db = getFirestore(app);
                        
                        signInAnonymously(appState.auth).catch((error) => console.error("Anonymous sign-in failed:", error));
                        
                    } catch (e) {
                        console.error("Firebase initialization failed:", e);
                        uiModule.showLoading('Firebase initialization error.');
                    }
                } else {
                    console.error("Firebase is not configured.");
                    uiModule.showLoading('Firebase not configured.');
                }
            },
            async submitReport(reportData, type) {
                if (!appState.db) {
                    console.error("Firestore is not initialized!");
                    alert("Database connection failed. Please refresh the page.");
                    return;
                }
                
                const collectionName = type === 'earthquake' ? 'reports' : 'locationReports';
                await addDoc(collection(appState.db, collectionName), reportData);
            },
            displayEarthquakeReportsInPopup(earthquakeId, container) {
                 if (!appState.db) return;
                 const q = query(collection(appState.db, "reports"), where("earthquakeId", "==", earthquakeId));
                 onSnapshot(q, (querySnapshot) => {
                    let reportsHTML = '<h4>User Reports</h4>';
                    if (querySnapshot.empty) {
                        reportsHTML += '<p>No reports yet.</p>';
                    } else {
                        querySnapshot.forEach((doc) => {
                            const report = doc.data();
                            reportsHTML += `
                                <div style="margin-top: 10px; border-top: 1px solid #555; padding-top: 10px;">
                                    <img src="${report.imageDataUrl}" alt="User report" style="width: 200px; height: 200px; object-fit: cover; border-radius: 5px; margin-bottom: 10px; cursor: pointer;" onclick="window.openImageViewer('${report.imageDataUrl}', ${report.latitude}, ${report.longitude})">
                                    <strong>${report.username}</strong>
                                    <small style="display: block; opacity: 0.8;">Taken on: ${report.dateTaken}</small>
                                    <p>${report.description}</p>
                                </div>
                            `;
                        });
                    }
                    container.innerHTML = reportsHTML;
                 });
            }
        };

        // --- MAP MODULE ---
        const mapModule = {
            init() {
                appState.map = L.map(dom.map, { zoomControl: false }).setView([20, 0], 2);
                L.control.zoom({ position: 'topright' }).addTo(appState.map);

                const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri'
                });
                const terrainLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 19
                });

                satelliteLayer.addTo(appState.map);
                dom.map.classList.add('map-is-satellite');
                
                appState.earthquakeMarkers = L.layerGroup().addTo(appState.map);
                appState.locationReportMarkers = L.markerClusterGroup().addTo(appState.map);

                this.addLocateControl();
                this.addLegend();

                return { satelliteLayer, terrainLayer };
            },
            addLocateControl() {
                const LocateControl = L.Control.extend({
                    options: { position: 'topright' },
                    onAdd: function (map) {
                        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                        const button = L.DomUtil.create('a', 'leaflet-control-locate', container);
                        button.href = '#';
                        button.title = 'Show my location';
                        button.role = 'button';
                        L.DomEvent.on(button, 'click', L.DomEvent.stop).on(button, 'click', () => {
                            uiModule.showLoading('Finding your location...');
                            map.locate({setView: true, maxZoom: 13});
                        });
                        return container;
                    }
                });
                appState.map.addControl(new LocateControl());
            },
            addLegend() {
                const legend = L.control({position: 'bottomright'});
                legend.onAdd = function (map) {
                    const container = L.DomUtil.create('div', 'legend-container');
                    const toggle = L.DomUtil.create('div', '', container);
                    const content = L.DomUtil.create('div', 'legend-content', container);
                    toggle.id = 'legend-toggle';
                    toggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>`;
                    const grades = [0, 3, 4, 5, 6, 7, 8, 9, 10];
                    let contentHTML = '<h4>Magnitude</h4>';
                    grades.forEach((from, i) => {
                        const to = grades[i + 1];
                        contentHTML += `<i style="background:${this.getMagnitudeColor(from + 0.1)};"></i> ${from}${to ? '&ndash;' + (to - 0.1).toFixed(1) : '+'}<br>`;
                    });
                    contentHTML += '<br><small>Circle size represents magnitude.</small>';
                    content.innerHTML = contentHTML;
                    L.DomEvent.on(toggle, 'click', (e) => { L.DomEvent.stop(e); container.classList.toggle('expanded'); });
                    L.DomEvent.disableClickPropagation(container);
                    return container;
                }.bind(this);
                legend.addTo(appState.map);
            },
            getMagnitudeColor(mag) {
                if (mag < 3) return '#ff073a'; if (mag < 4) return '#ff9e00'; if (mag < 5) return '#f9ff00';
                if (mag < 6) return '#39ff14'; if (mag < 7) return '#00f5ff'; if (mag < 8) return '#004dff';
                if (mag < 9) return '#8f00ff'; if (mag < 10) return '#ff00ff'; return '#ff1493';
            },
            getMagnitudeRadius(mag) { return 1 + (Math.floor(mag) * 1.3); },
            updateEarthquakeMarkers(earthquakes) {
                if (appState.map.getSize().x === 0) return setTimeout(() => this.updateEarthquakeMarkers(earthquakes), 100);

                if (appState.heatLayer) appState.map.removeLayer(appState.heatLayer);
                appState.earthquakeMarkers.clearLayers();
                if (earthquakes.length === 0) return;

                const heatPoints = earthquakes.map(eq => [eq.geometry.coordinates[1], eq.geometry.coordinates[0], eq.properties.mag]);
                appState.heatLayer = L.heatLayer(heatPoints, { radius: 25, blur: 15, maxZoom: 18, max: 8.0, gradient: {0.4: 'blue', 0.6: 'lime', 0.8: 'yellow', 1.0: 'red'} }).addTo(appState.map);

                earthquakes.forEach(eq => {
                    const [lon, lat] = eq.geometry.coordinates;
                    const { mag, place, time } = eq.properties;
                    const earthquakeId = eq.id;

                    const popupContent = document.createElement('div');
                    popupContent.innerHTML = `<b>Magnitude:</b> ${mag}<br><b>Location:</b> ${place}<br><b>Time:</b> ${new Date(time).toLocaleString()}<br><hr style="margin: 5px 0;"><div id="reports-container-${earthquakeId}"><p>Loading reports...</p></div><button class="w-full bg-indigo-600 text-white font-bold py-2 px-2 rounded-md hover:bg-indigo-700 transition duration-300 mt-2" onclick="window.openSubmissionModal({ type: 'earthquake', id: '${earthquakeId}' })">Add Your Report</button>`;

                    const marker = L.circleMarker([lat, lon], {
                        radius: this.getMagnitudeRadius(mag),
                        color: this.getMagnitudeColor(mag),
                        weight: 1,
                        fillColor: this.getMagnitudeColor(mag),
                        fillOpacity: 0.3
                    }).bindPopup(popupContent);
                    
                    marker.on('popupopen', () => {
                        const reportsContainer = document.getElementById(`reports-container-${earthquakeId}`);
                        if (reportsContainer) firebaseModule.displayEarthquakeReportsInPopup(earthquakeId, reportsContainer);
                    });
                    appState.earthquakeMarkers.addLayer(marker);
                });
            },
            async fetchAndDisplayLocationReports(showIndicator = true) {
                if (!appState.db) return;
                if (showIndicator) uiModule.showLoading('Loading user reports...', true);
                
                const mapBounds = appState.map.getBounds();
                const startDate = new Date(dom.startDate.value);
                const endDate = new Date(dom.endDate.value);
                endDate.setHours(23, 59, 59, 999);

                const q = query(
                    collection(appState.db, "locationReports"),
                    where("createdAt", ">=", startDate),
                    where("createdAt", "<=", endDate)
                );

                const querySnapshot = await getDocs(q);
                
                const reportsInView = [];
                const selectedCountry = dom.countryFilter.options[dom.countryFilter.selectedIndex].text;
                const selectedCity = dom.cityFilter.value;

                querySnapshot.forEach((doc) => {
                    const report = doc.data();
                    let countryMatch = !selectedCountry || !dom.countryFilter.value || report.countryName === selectedCountry;
                    let cityMatch = !selectedCity || report.city === selectedCity;
                    
                    if (countryMatch && cityMatch) {
                        reportsInView.push(report);
                    }
                });
                this.updateLocationReportMarkers(reportsInView, showIndicator);
            },
            updateLocationReportMarkers(reports, showIndicator = true) {
                appState.locationReportMarkers.clearLayers();
                const iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="24px" height="24px"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 11.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 6.5 12 6.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5z"/></svg>`;
                const cameraIcon = L.divIcon({
                    html: `<div style="background-color: #4f46e5; border-radius: 50%; padding: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.4);">${iconHtml}</div>`,
                    className: '', iconSize: [32, 32], iconAnchor: [16, 16], popupAnchor: [0, -16]
                });

                reports.forEach(report => {
                    const marker = L.marker([report.latitude, report.longitude], { icon: cameraIcon });
                    marker.reportData = report;
                    marker.bindPopup(`<div style="max-width: 250px;"><img src="${report.imageDataUrl}" alt="User report" style="height: 200px; object-fit: cover; border-radius: 5px; margin-bottom: 10px; cursor: pointer;" onclick="window.openImageViewer('${report.imageDataUrl}', ${report.latitude}, ${report.longitude})"><strong>${report.username}</strong><small style="display: block; opacity: 0.8;">Taken on: ${report.dateTaken}</small><p>${report.description}</p></div>`);
                    appState.locationReportMarkers.addLayer(marker);
                });

                if(showIndicator) uiModule.hideLoading();
            },
            populateCountries() {
                appState.countriesData.sort((a, b) => a.name.localeCompare(b.name));
                appState.countriesData.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.iso2;
                    option.textContent = country.name;
                    dom.countryFilter.appendChild(option);
                });
            },
            populateCities(countryCode) {
                dom.cityFilter.innerHTML = '<option value="">All Cities</option>';
                if (!countryCode) {
                    dom.cityFilter.disabled = true;
                    return;
                }
                const countryCities = appState.citiesData.filter(city => city.country_code === countryCode).sort((a,b) => a.name.localeCompare(b.name));
                countryCities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.name;
                    option.textContent = city.name;
                    dom.cityFilter.appendChild(option);
                });
                dom.cityFilter.disabled = false;
            }
        };

        // --- EVENT HANDLERS & APP LOGIC ---
        const eventHandlers = {
            init() {
                const { satelliteLayer, terrainLayer } = mapModule.init();

                dom.sheetToggle.addEventListener('click', () => dom.controlsContainer.classList.toggle('is-open'));
                dom.themeSwitch.addEventListener('change', () => document.documentElement.classList.toggle('dark', dom.themeSwitch.checked));
                dom.mapStyleSwitch.addEventListener('change', () => {
                    if (dom.mapStyleSwitch.checked) {
                        appState.map.removeLayer(satelliteLayer);
                        appState.map.addLayer(terrainLayer);
                        dom.map.classList.remove('map-is-satellite');
                        dom.map.classList.add('map-is-terrain');
                    } else {
                        appState.map.removeLayer(terrainLayer);
                        appState.map.addLayer(satelliteLayer);
                        dom.map.classList.add('map-is-satellite');
                        dom.map.classList.remove('map-is-terrain');
                    }
                });

                appState.map.on('locationfound', (e) => {
                    uiModule.hideLoading();
                    L.marker(e.latlng).addTo(appState.map).bindPopup("You are here!").openPopup();
                });
                appState.map.on('locationerror', () => {
                    uiModule.showLoading('Location access denied or unavailable.');
                    uiModule.hideLoading(3000);
                });
                appState.map.on('click', (e) => {
                    // Prevent opening submission modal if clicking on a marker/control
                    if (e.originalEvent.target.closest('.leaflet-marker-icon') || e.originalEvent.target.closest('.leaflet-control')) return;
                    uiModule.openSubmissionModal({ type: 'location', lat: e.latlng.lat, lng: e.latlng.lng });
                });

                const date = new Date(), y = date.getFullYear(), m = date.getMonth();
                dom.startDate.value = new Date(y, m, 1).toISOString().split('T')[0];
                dom.endDate.value = new Date().toISOString().split('T')[0];

                [dom.startDate, dom.endDate, dom.minMagnitude, dom.maxMagnitude].forEach(el => el.addEventListener('change', apiModule.fetchEarthquakes));
                
                dom.countryFilter.addEventListener('change', () => {
                    const countryCode = dom.countryFilter.value;
                    mapModule.populateCities(countryCode);
                    if (countryCode) {
                        const country = appState.countriesData.find(c => c.iso2 === countryCode);
                        if (country) appState.map.setView([parseFloat(country.latitude), parseFloat(country.longitude)], 5);
                    } else {
                        appState.map.setView([20, 0], 2);
                    }
                    this.applyFilters();
                });

                dom.cityFilter.addEventListener('change', this.applyFilters);
                dom.refreshBtn.addEventListener('click', apiModule.fetchEarthquakes);
                appState.locationReportMarkers.on('clusterclick', (a) => {
                    const markers = a.layer.getAllChildMarkers();
                    let popupContent = '<div class="gallery-popup-container">';
                    markers.forEach(marker => {
                        const { reportData } = marker;
                        popupContent += `<img src="${reportData.imageDataUrl}" onclick="window.openImageViewer('${reportData.imageDataUrl}', ${reportData.latitude}, ${reportData.longitude})">`;
                    });
                    popupContent += '</div>';
                    L.popup().setLatLng(a.layer.getLatLng()).setContent(popupContent).openOn(appState.map);
                });
                appState.map.on('moveend', () => mapModule.fetchAndDisplayLocationReports(true));

                // Modal event listeners
                dom.closeModalBtn.addEventListener('click', uiModule.closeSubmissionModal.bind(uiModule));
                dom.submitReportBtn.addEventListener('click', this.handleSubmit.bind(this));
                dom.imageUpload.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        dom.imagePreview.src = URL.createObjectURL(file);
                    }
                });
                dom.closeViewerBtn.addEventListener('click', uiModule.closeImageViewer.bind(uiModule));
                dom.imageViewerModal.addEventListener('click', (e) => {
                    if (e.target === dom.imageViewerModal) uiModule.closeImageViewer();
                });


                window.openImageViewer = uiModule.openImageViewer.bind(uiModule);
                window.openSubmissionModal = uiModule.openSubmissionModal.bind(uiModule);
            },
            async handleSubmit() {
                if (!appState.db) {
                    console.error("Firestore is not initialized!");
                    alert("Database connection failed. Please refresh the page.");
                    return;
                }
                if (!appState.currentSubmissionContext) return;

                const file = dom.imageUpload.files[0];
                const username = dom.username.value.trim() || 'Anonymous';
                const description = dom.description.value.trim();
                const dateTaken = dom.dateTaken.value;

                if (!file || !description || !dateTaken) {
                    alert('Please provide an image, date, and description.');
                    return;
                }

                uiModule.toggleModalForm(true);
                uiModule.showLoading('Compressing image...', true);

                try {
                    const imageDataUrl = await uiModule.resizeAndWatermarkImage(file, 800, 800, 0.8, username);
                    uiModule.showLoading('Uploading report...', true);

                    let reportData = {
                        username, description, dateTaken, imageDataUrl, createdAt: new Date()
                    };

                    if (appState.currentSubmissionContext.type === 'earthquake') {
                        reportData.earthquakeId = appState.currentSubmissionContext.id;
                    } else if (appState.currentSubmissionContext.type === 'location') {
                        reportData.latitude = appState.currentSubmissionContext.lat;
                        reportData.longitude = appState.currentSubmissionContext.lng;
                        
                        const address = await apiModule.getAddressFromCoords(reportData.latitude, reportData.longitude);
                        reportData.countryName = address.countryName;
                        reportData.city = address.city;
                    }

                    await firebaseModule.submitReport(reportData, appState.currentSubmissionContext.type);
                    
                    uiModule.showLoading('Report submitted!', false);
                    uiModule.hideLoading(2000);
                    uiModule.resetSubmissionForm();
                    mapModule.fetchAndDisplayLocationReports(false);

                } catch (error) {
                    console.error("Error submitting report: ", error);
                    uiModule.showLoading('Submission failed. Please try again.', false);
                    uiModule.hideLoading(3000);
                } finally {
                     uiModule.toggleModalForm(false);
					 uiModule.closeSubmissionModal();
                }
            },
            applyFilters() {
                let filteredEarthquakes = [...appState.allEarthquakes];
                const selectedCountry = dom.countryFilter.options[dom.countryFilter.selectedIndex].text;
                const selectedCity = dom.cityFilter.value;

                if (selectedCountry && dom.countryFilter.value) {
                    filteredEarthquakes = filteredEarthquakes.filter(eq => eq.properties.place?.toLowerCase().includes(selectedCountry.toLowerCase()));
                }
                if (selectedCity) {
                     filteredEarthquakes = filteredEarthquakes.filter(eq => eq.properties.place?.toLowerCase().includes(selectedCity.toLowerCase()));
                }
                mapModule.updateEarthquakeMarkers(filteredEarthquakes);
                mapModule.fetchAndDisplayLocationReports();
            }
        };

        // --- APP INITIALIZATION ---
        function startApp() {
            firebaseModule.init();
            eventHandlers.init();
            apiModule.fetchCountryCityData();
            apiModule.fetchEarthquakes();
        }

        function initialCheck() {
            if (localStorage.getItem('hideWelcomeMessage')) {
                startApp();
            } else {
                uiModule.openWelcomeModal();
                dom.closeWelcomeBtn.addEventListener('click', () => {
                    if (dom.dontShowAgainCheck.checked) {
                        localStorage.setItem('hideWelcomeMessage', 'true');
                    }
                    uiModule.closeWelcomeModal();
                    startApp();
                }, { once: true });
            }
        }
        
        initialCheck();

    </script>
</body>
</html>

